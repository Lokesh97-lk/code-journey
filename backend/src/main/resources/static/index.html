<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | CodeJourney</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <script>
        // SECURITY CHECK: Redirect if not logged in
        if (!localStorage.getItem('userToken')) {
            // Fix for Invalid URL error: Use origin directly
            window.location.href = window.location.origin + '/login.html';
        }
    </script>
</head>
<body class="h-screen w-screen bg-slate-900 text-white flex flex-col md:flex-row overflow-hidden">

    <!-- MOBILE HEADER -->
    <header class="md:hidden bg-slate-900 border-b border-slate-800 p-4 flex justify-between items-center z-50 fixed top-0 w-full">
        <span class="font-bold gradient-text text-lg">CodeJourney</span>
        <button id="mobileMenuBtn" class="text-slate-300 focus:outline-none">
            <i class="fa-solid fa-bars text-2xl"></i>
        </button>
    </header>

    <!-- MAIN APP CONTENT WRAPPER -->
    <div id="mainAppContent" class="h-full w-full flex overflow-hidden bg-slate-900 pt-16 md:pt-0 relative">
        
        <!-- SIDEBAR -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-72 bg-slate-900 border-r border-slate-800 flex flex-col sidebar-closed md:sidebar-open md:relative md:transform-none shadow-2xl md:shadow-none transition-transform duration-300">
            <div class="p-6 border-b border-slate-800 hidden md:block">
                <span class="text-2xl font-bold gradient-text">CodeJourney</span>
                <span class="text-xs block text-slate-500 mt-1">World of Code</span>
            </div>
            
            <nav class="flex-1 overflow-y-auto py-4 space-y-1 px-3">
                <button onclick="switchTab('dashboard')" id="nav-dashboard" class="sidebar-link active w-full flex items-center px-4 py-3 text-slate-300 rounded-lg hover:bg-slate-800 transition-colors text-left gap-3">
                    <i class="fa-solid fa-chart-line w-5"></i> My Activity
                </button>
                <button onclick="switchTab('practice')" id="nav-practice" class="sidebar-link w-full flex items-center px-4 py-3 text-slate-300 rounded-lg hover:bg-slate-800 transition-colors text-left gap-3">
                    <i class="fa-solid fa-keyboard w-5"></i> Practice Lab
                </button>
                <div class="px-4 py-2 text-xs font-bold text-slate-500 uppercase tracking-wider mt-4">Concepts</div>
                <button onclick="switchTab('java')" id="nav-java" class="sidebar-link w-full flex items-center px-4 py-3 text-slate-300 rounded-lg hover:bg-slate-800 transition-colors text-left gap-3">
                    <i class="fa-brands fa-java w-5"></i> Java
                </button>
                <button onclick="switchTab('python')" id="nav-python" class="sidebar-link w-full flex items-center px-4 py-3 text-slate-300 rounded-lg hover:bg-slate-800 transition-colors text-left gap-3">
                    <i class="fa-brands fa-python w-5"></i> Python
                </button>
                <button onclick="switchTab('cpp')" id="nav-cpp" class="sidebar-link w-full flex items-center px-4 py-3 text-slate-300 rounded-lg hover:bg-slate-800 transition-colors text-left gap-3">
                    <i class="fa-solid fa-code w-5"></i> C++
                </button>
                <button onclick="switchTab('sql')" id="nav-sql" class="sidebar-link w-full flex items-center px-4 py-3 text-slate-300 rounded-lg hover:bg-slate-800 transition-colors text-left gap-3">
                    <i class="fa-solid fa-database w-5"></i> SQL
                </button>
            </nav>

            <!-- CONTACT & LOGOUT -->
            <div class="p-4 border-t border-slate-800 bg-slate-900/50">
                <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">Connect with Lokesh</h4>
                <div class="flex space-x-4 mb-4 justify-start pl-2">
                    <a href="mailto:lokesh972007@gmail.com" class="text-slate-400 hover:text-white transition" title="Email"><i class="fa-solid fa-envelope text-lg"></i></a>
                    <a href="https://www.instagram.com/_lokesh_.97?igsh=cGVnMzdlM2w2NGFn" target="_blank" class="text-slate-400 hover:text-pink-500 transition" title="Instagram"><i class="fa-brands fa-instagram text-lg"></i></a>
                    <a href="https://www.linkedin.com/in/lokesh-saravanan-517b88315?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=android_app" target="_blank" class="text-slate-400 hover:text-sky-500 transition" title="LinkedIn"><i class="fa-brands fa-linkedin text-lg"></i></a>
                </div>
                <button id="logoutBtn" class="w-full flex items-center justify-center px-4 py-2 bg-red-500/10 text-red-400 rounded-lg hover:bg-red-500/20 transition-colors text-sm">
                    <i class="fa-solid fa-right-from-bracket mr-2"></i> Logout
                </button>
            </div>
        </aside>

        <!-- CONTENT AREA -->
        <main id="contentArea" class="flex-1 h-full flex flex-col overflow-y-auto p-4 md:p-10 scroll-smooth relative w-full">
            
            <!-- Zen Mode Toggle -->
            <div class="absolute top-4 right-4 hidden md:block z-50">
                <button id="zenModeBtn" class="text-slate-400 hover:text-sky-400 transition text-sm flex items-center gap-2 bg-slate-800/50 px-3 py-1 rounded-full backdrop-blur-sm border border-slate-700/50 hover:border-sky-500/30">
                    <i class="fa-solid fa-expand"></i> Zen Mode
                </button>
            </div>

            <!-- VIEW: Dashboard (Activity) -->
            <div id="view-dashboard" class="view-section max-w-5xl mx-auto w-full animate-fade-in">
                <div class="mb-8">
                    <h2 class="text-3xl md:text-4xl font-bold text-white">Welcome Back, <span id="userEmailDisplay" class="text-sky-400">Dev</span></h2>
                    <p class="text-slate-400 mt-2">Track your daily concept mastery.</p>
                </div>
                
                <h3 class="text-xl font-semibold text-white mb-4 border-b border-slate-700 pb-2">My Activity in the World of Code</h3>
                <div id="progress-container" class="glass-panel p-6 rounded-xl min-h-[200px]">
                    <p id="no-progress-msg" class="text-slate-400 text-center py-8">
                        No activity recorded yet. <br>
                        <span class="text-sm">Go to the <b>Practice Lab</b> to write tests for what you've learned!</span>
                    </p>
                    <div id="progress-list" class="space-y-3"></div>
                </div>
            </div>

            <!-- VIEW: Practice Lab -->
            <div id="view-practice" class="view-section hidden-force max-w-4xl mx-auto w-full animate-fade-in">
                <h2 class="text-3xl font-bold text-white mb-2">Practice Lab</h2>
                <p class="text-slate-400 mb-6">Select a concept and write a test case or re-write the code to prove your understanding.</p>
                <div class="glass-panel p-6 md:p-8 rounded-xl">
                    <form id="practiceForm">
                        <div class="mb-6">
                            <label class="block text-sm font-bold text-slate-300 mb-2">Topic / Concept</label>
                            <select name="topic" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-sky-500 outline-none">
                                <option value="Python - Slicing">Python: String Slicing</option>
                                <option value="Python - Dictionaries">Python: Dictionary Merging</option>
                                <option value="Java - Recursion">Java: Recursion</option>
                                <option value="Java - Matrix">Java: 2D Arrays</option>
                                <option value="C++ - Pointers">C++: Pointers</option>
                                <option value="SQL - Joins">SQL: Joins</option>
                                <option value="General - Logic">General Logic</option>
                            </select>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-bold text-slate-300 mb-2">Your Code / Test Case</label>
                            <textarea name="code" rows="10" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-4 text-white font-mono text-sm focus:border-sky-500 outline-none transition resize-none" placeholder="// Write your test case or code explanation here..."></textarea>
                        </div>
                        <button type="submit" id="submitPracticeBtn" class="w-full bg-sky-600 hover:bg-sky-500 text-white font-bold py-3 rounded-lg shadow-lg transition-all flex justify-center items-center gap-2">
                            <i class="fa-solid fa-paper-plane"></i> Submit to Activity Log
                        </button>
                    </form>
                    <div id="practiceResult" class="mt-4 text-center hidden-force"></div>
                </div>
            </div>

            <!-- VIEW: Java -->
            <div id="view-java" class="view-section hidden-force w-full animate-fade-in">
                <h2 class="text-3xl font-bold text-white mb-6 flex items-center gap-3"><i class="fa-brands fa-java text-orange-500"></i> Java Concepts</h2>
                <div id="java-examples" class="grid grid-cols-1 xl:grid-cols-2 gap-6"></div>
            </div>
            <!-- VIEW: Python -->
            <div id="view-python" class="view-section hidden-force w-full animate-fade-in">
                <h2 class="text-3xl font-bold text-white mb-6 flex items-center gap-3"><i class="fa-brands fa-python text-yellow-400"></i> Python Concepts</h2>
                <div id="python-examples" class="grid grid-cols-1 xl:grid-cols-2 gap-6"></div>
            </div>
            <!-- VIEW: C++ -->
            <div id="view-cpp" class="view-section hidden-force w-full animate-fade-in">
                <h2 class="text-3xl font-bold text-white mb-6 flex items-center gap-3"><i class="fa-solid fa-code text-blue-500"></i> C++ Concepts</h2>
                <div id="cpp-examples" class="grid grid-cols-1 xl:grid-cols-2 gap-6"></div>
            </div>
            <!-- VIEW: SQL -->
            <div id="view-sql" class="view-section hidden-force w-full animate-fade-in">
                <h2 class="text-3xl font-bold text-white mb-6 flex items-center gap-3"><i class="fa-solid fa-database text-emerald-500"></i> SQL Concepts</h2>
                <div id="sql-examples" class="grid grid-cols-1 xl:grid-cols-2 gap-6"></div>
            </div>

        </main>
    </div>

    <!-- Logic Modal (Popup) -->
    <div id="logicModal" class="modal fixed inset-0 z-[70] flex items-center justify-center bg-black/80 backdrop-blur-md p-4">
        <div class="modal-content bg-slate-800 border border-sky-500/30 w-full max-w-2xl rounded-2xl p-6 md:p-8 shadow-2xl relative max-h-[90vh] overflow-y-auto">
            <button id="closeModal" class="absolute top-4 right-4 text-slate-400 hover:text-white text-2xl">&times;</button>
            <h3 id="logicTitle" class="text-2xl font-bold text-sky-400 mb-4 pr-8">Logic Explanation</h3>
            <div id="logicBody" class="text-slate-300 leading-relaxed text-base space-y-4"></div>
            <div class="mt-8 pt-4 border-t border-slate-700 text-right">
                <button class="text-sm text-sky-400 hover:underline" onclick="document.getElementById('closeModal').click()">Close Explanation</button>
            </div>
        </div>
    </div>

<script>
    const API_URL = "/api"; 
    let USER_TOKEN = localStorage.getItem('userToken');

    // --- DATA ---
    const logicData = {
        "py1": "<p><strong>Concept: String Slicing</strong></p><p>In Python, slicing allows you to extract parts of a sequence using <code>[start:stop:step]</code>. A step of <code>-1</code> reverses the sequence.</p><p>This technique is fundamental for efficient data manipulation without loops.</p>",
        "py2": "<p><strong>Concept: Tuple Unpacking</strong></p><p>Python allows swapping variables in a single line: <code>a, b = b, a</code>. This works by packing the values into a tuple on the right side and unpacking them into variables on the left side.</p>",
        "py3": "<p><strong>Concept: Merge Operator</strong></p><p>The <code>|</code> operator (Python 3.9+) merges two dictionaries. If keys overlap, the value from the second dictionary overwrites the first.</p>",
        "java1": "<p><strong>Concept: Quadratic Formula</strong></p><p>Calculates roots of <code>ax² + bx + c = 0</code> using the discriminant <code>b² - 4ac</code>. Handling the discriminant determines if roots are real, equal, or complex.</p>",
        "java4": "<p><strong>Concept: Recursion</strong></p><p>A method calling itself. Crucial for dividing complex problems (like tree traversal) into simpler sub-problems. Must have a base case to stop execution.</p>",
        "cpp4": "<p><strong>Concept: Precision & Branching</strong></p><p>Shows how to use <code>if/else</code> logic for mathematical decision making. Using <code>float</code> ensures division doesn't result in integer truncation.</p>",
        "cpp7": "<p><strong>Concept: Structures</strong></p><p><code>struct</code> allows grouping different data types (int, char, float) under one name, acting as a blueprint for complex data records like a Student database.</p>",
        "sql5": "<p><strong>Concept: Stored Procedures</strong></p><p>Pre-compiled SQL code saved on the database. Enhances security by hiding table structures and improves performance by caching execution plans.</p>"
    };

    const codeExamples = {
        java: [
            { id: "java1", title: "1. Quadratic Equation Solver", code: `public class Main {\n  public static void main(String[] args) {\n    double a = 2.3, b = 4, c = 5.6;\n    // ... (Discriminant Logic)\n  }\n}` },
            { id: "java4", title: "2. Recursion: Sum of Numbers", code: `public class AddNumbers {\n    public static int addNumbers(int num) {\n        if (num != 0)\n            return num + addNumbers(num - 1);\n        else\n            return num;\n    }\n}` }
        ],
        python: [
            { id: "py1", title: "1. Reverse String (Slicing)", code: `a = "Hello World!"\nprint(a[::-1])\n# Output: !dlroW olleH` },
            { id: "py2", title: "2. In-place Swap", code: `a = 10\nb = 5\na, b = b, a\nprint(a, b)` },
            { id: "py3", title: "3. Dictionary Merge (|)", code: `x = {"key1": "value1"}\ny = {"key2": "value2"}\nz = x | y` }
        ],
        cpp: [
             { id: "cpp4", title: "1. Quadratic Roots", code: `#include <iostream>\n// ... Standard quadratic logic` },
             { id: "cpp7", title: "2. Structs", code: `struct student {\n    char name[50];\n    int roll;\n} s;` }
        ],
        sql: [
            { id: "sql5", title: "1. Stored Procedures", code: `CREATE PROCEDURE GetCustomers\nAS\nSELECT * FROM Customers\nGO;` }
        ]
    };

    // --- APP LOGIC ---
    
    function switchTab(tabName) {
        document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
        const activeLink = document.getElementById(`nav-${tabName}`);
        if(activeLink) activeLink.classList.add('active');
        
        const sidebar = document.getElementById('sidebar');
        if (!sidebar.classList.contains('sidebar-closed') && window.innerWidth < 768) {
            sidebar.classList.add('sidebar-closed');
            sidebar.classList.remove('sidebar-open');
        }

        document.querySelectorAll('.view-section').forEach(v => v.classList.add('hidden-force'));
        const targetView = document.getElementById(`view-${tabName}`);
        if(targetView) {
            targetView.classList.remove('hidden-force');
            targetView.style.animation = 'none';
            targetView.offsetHeight; /* trigger reflow */
            targetView.style.animation = null; 
        }

        if (tabName === 'dashboard') fetchProgress();
    }

    function loadExamples() {
        const createCard = (item) => `
            <div class="glass-panel p-6 rounded-xl hover:border-sky-500/50 transition group relative">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-lg font-semibold text-sky-400 group-hover:text-sky-300">${item.title}</h3>
                    <button data-logic="${item.id}" class="logic-btn text-xs bg-sky-600 hover:bg-sky-500 px-3 py-1.5 rounded text-white transition font-bold shadow-lg shadow-sky-900/20">Explain Logic</button>
                </div>
                <pre><code class="language-java">${item.code.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</code></pre>
                <div class="mt-4 pt-4 border-t border-slate-700/50 flex justify-end">
                    <button onclick="switchTab('practice')" class="text-xs text-slate-400 hover:text-emerald-400 transition flex items-center gap-1">
                        <i class="fa-solid fa-pen-to-square"></i> Write Test for this
                    </button>
                </div>
            </div>`;

        document.getElementById('java-examples').innerHTML = codeExamples.java.map(createCard).join('');
        document.getElementById('python-examples').innerHTML = codeExamples.python.map(createCard).join('');
        document.getElementById('cpp-examples').innerHTML = codeExamples.cpp.map(createCard).join('');
        document.getElementById('sql-examples').innerHTML = codeExamples.sql.map(createCard).join('');
        
        attachModalListeners();
    }

    function attachModalListeners() {
        const modal = document.getElementById('logicModal');
        document.querySelectorAll('.logic-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const key = e.target.dataset.logic;
                document.getElementById('logicBody').innerHTML = logicData[key] || "<p>Detailed explanation coming soon.</p>";
                modal.classList.add('open');
            });
        });
        document.getElementById('closeModal').addEventListener('click', () => modal.classList.remove('open'));
    }

    async function fetchProgress() {
        if (!USER_TOKEN) return; 
        const progressList = document.getElementById('progress-list');
        const noProgressMsg = document.getElementById('no-progress-msg');
        
        try {
            const res = await fetch(`${API_URL}/progress`, { headers: { 'Authorization': USER_TOKEN } });
            if (!res.ok) { 
                if (res.status === 401) logout(); 
                return; 
            }
            
            const activities = await res.json();
            
            if (activities.length === 0) {
                progressList.innerHTML = '';
                noProgressMsg.classList.remove('hidden-force');
            } else {
                noProgressMsg.classList.add('hidden-force');
                progressList.innerHTML = activities.map(a => `
                    <div class="flex justify-between items-center bg-slate-800/50 border border-slate-700 p-4 rounded-lg hover:bg-slate-800 transition animate-fade-in">
                        <div class="flex items-center gap-4">
                            <div class="bg-emerald-500/10 text-emerald-400 p-3 rounded-full">
                                <i class="fa-solid fa-check"></i>
                            </div>
                            <div>
                                <span class="font-bold text-white block">${a.quizName}</span>
                                <span class="text-xs text-slate-400">Completed: ${new Date(a.completedAt).toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="text-xs font-bold text-sky-400 bg-sky-900/20 px-3 py-1 rounded uppercase tracking-wide">Logged</div>
                    </div>
                `).join('');
            }
        } catch (err) { console.error(err); }
    }

    async function submitPractice(e) {
        e.preventDefault();
        const submitBtn = document.getElementById('submitPracticeBtn');
        const resultDiv = document.getElementById('practiceResult');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';

        const formData = new FormData(e.target);
        const payload = {
            topic: formData.get('topic'),
            code: formData.get('code')
        };

        try {
            const res = await fetch(`${API_URL}/activity/submit`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': USER_TOKEN },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                resultDiv.innerHTML = `<span class="text-emerald-400 font-bold flex items-center justify-center gap-2"><i class="fa-solid fa-circle-check"></i> Activity Logged Successfully!</span>`;
                resultDiv.classList.remove('hidden-force');
                e.target.reset();
                // Auto-redirect to Dashboard after success
                setTimeout(() => {
                    switchTab('dashboard');
                    resultDiv.classList.add('hidden-force');
                }, 1500);
            } else {
                resultDiv.innerHTML = `<span class="text-red-400">Save failed. Try again.</span>`;
                resultDiv.classList.remove('hidden-force');
            }
        } catch(err) {
            console.error(err);
            resultDiv.innerHTML = `<span class="text-red-400">Error connecting to server.</span>`;
            resultDiv.classList.remove('hidden-force');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Submit to Activity Log';
        }
    }

    function logout() {
        localStorage.clear();
        USER_TOKEN = null;
        // Fix for Invalid URL error: Use origin directly
        window.location.href = window.location.origin + '/login.html';
    }

    // INITIALIZATION
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Display User Info
        if(localStorage.getItem('userEmail')) {
            document.getElementById('userEmailDisplay').textContent = localStorage.getItem('userEmail').split('@')[0];
        }

        // 2. Load Static Content
        loadExamples(); 
        fetchProgress(); 

        // 3. Attach Global Listeners
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('practiceForm').addEventListener('submit', submitPractice);
        
        // Mobile Sidebar Toggle
        const mobileBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        mobileBtn.addEventListener('click', () => {
            if (sidebar.classList.contains('sidebar-closed')) {
                sidebar.classList.remove('sidebar-closed');
                sidebar.classList.add('sidebar-open');
            } else {
                sidebar.classList.add('sidebar-closed');
                sidebar.classList.remove('sidebar-open');
            }
        });
        
        // Zen Mode Toggle
        document.getElementById('zenModeBtn').addEventListener('click', () => {
            document.body.classList.toggle('zen-mode');
            const isZen = document.body.classList.contains('zen-mode');
            document.getElementById('zenModeBtn').innerHTML = isZen 
                ? '<i class="fa-solid fa-compress"></i> Exit Zen' 
                : '<i class="fa-solid fa-expand"></i> Zen Mode';
        });
    });
</script>
</body>
</html>